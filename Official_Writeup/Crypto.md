# MoeCTF2023 Crypto Writeup
Cryptoå‡ºé¢˜ç»„ï¼škoito, shallow

## å‰è¨€
MoeCTF2022 Cryptoè¯•é¢˜ ~~ è½å®ç«‹å¾·æ ‘äººæ ¹æœ¬ä»»åŠ¡ï¼Œéµå¾ªå¾·æ™ºä½“ç¾åŠ³å…¨é¢å‘å±•è¦æ±‚ï¼Œè´¯å½»ã€Šæ·±åŒ–æ–°æ—¶ä»£CTFæ”¹é©æ€»ä½“æ–¹æ¡ˆã€‹ï¼Œä½“ç°äº†MoeCTFæ”¹é©çš„æ–¹å‘ã€‚è¯•å·çªå‡ºå¯†ç å­¦å­¦ç§‘ç‰¹ç‚¹ï¼ŒåŠ å¼ºåŸºç¡€æ€§ä¸å…³é”®èƒ½åŠ›è€ƒæŸ¥ï¼Œå……åˆ†å‘æŒ¥å¯†ç å­¦å­¦ç§‘çš„é€‰æ‹”ä¸å¼•å¯¼åŠŸèƒ½ã€‚MoeCTF2022 CryptoåšæŒç«‹å¾·æ ‘äººï¼Œä½“ç°CTFæ–‡åŒ–çš„è‚²äººä»·å€¼ï¼Œçªå‡ºç†æ€§æ€ç»´çš„ä»·å€¼ï¼Œæ³¨é‡æ•°å­¦çš„åŸºç¡€æ€§ï¼Œå¼•å¯¼å­¦ç”Ÿå¯¹CTFæ¦‚å¿µã€æ–¹æ³•æ›´æ·±åˆ»çš„è®¤çŸ¥ï¼Œåœ¨åŸºç¡€æ€§ã€ç»¼åˆæ€§ã€åº”ç”¨æ€§ã€åˆ›æ–°æ€§ç­‰æ–¹é¢éƒ½è¿›è¡Œäº†æ·±å…¥çš„è€ƒæŸ¥ã€‚CTFç¨³ä¸­æœ‰å˜ï¼Œå˜ä¸­æœ‰æ–°ï¼Œéš¾åº¦è®¾è®¡ç§‘å­¦ï¼Œ ~~ è¾ƒå¥½çš„å‘æŒ¥äº†MoeCTFçš„é€‰æ‹”åŠŸèƒ½ï¼Œå¯¹èŒæ–°å­¦ä¹ å¯†ç çŸ¥è¯†å‘æŒ¥äº†ç§¯æçš„å¼•å¯¼å’Œä¿ƒè¿›ä½œç”¨ã€‚

## cryptoæŒ‡åŒ—

ç›´æ¥è·‘ä¸€éæŒ‡åŒ—æœ€åçš„è„šæœ¬å³å¯å¾—åˆ°flag

## baby_e

å› ä¸ºeè¶³å¤Ÿå°ï¼Œæ‰€ä»¥æœ‰ `m^e == k * n + c`ï¼Œç›´æ¥çˆ†ç ´kå³å¯

å¯ä»¥å‚è€ƒ[ctf-wiki](https://ctf-wiki.org/crypto/asymmetric/rsa/rsa_e_attack/#_2)

```python
for k in range(1<<16):
    root, acc = iroot(k*n + c,7)
    if acc:
        print(f"found k={k}")
        print(long_to_bytes(root))
        break
```

## factor_signin

flagåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå‰åŠéƒ¨åˆ†ç”¨äº†ä¸¤ä¸ª2048bitsçš„è´¨æ•°ï¼Œä¹Ÿæ²¡æœ‰æ³„æ¼åˆ«çš„ä¿¡æ¯ï¼Œ~~æ‰€ä»¥è¿™æ˜¯ä¸ªå·¥å…·é¢˜~~ï¼Œç›´æ¥factordbç”¨n1å¯ä»¥æŸ¥åˆ°pqçš„å€¼ï¼›ååŠéƒ¨åˆ†æ˜¯20ä¸ªå°è´¨æ•°ç›¸ä¹˜ï¼Œå¯ä»¥ç”¨yafuå¿«é€Ÿåˆ†è§£

```python
e = 65537
c1 =  10004937130983861141937782436252502991050957330184611684406783226971057978666503675149401388381995491152372622456604317681236160071166819028679754762162125904637599991943368450200313304999566592294442696755822585022667008378021280392976010576970877334159755332946926433635584313137140987588847077645814987268595739733550220882135750267567373532603503399428451548677091911410732474324157868011686641243202218731844256789044721309478991918322850448456919991540932206923861653518190974620161055008847475600980152660468279765607319838003177639654115075183493029803981527882155542925959658123816315099271123470754815045214896642428657264709805029840253303446203030294879166242867850331945166255924821406218090304893024711068773287842075208409312312188560675094244318565148284432361706108491327014254387317744284876018328591380705408407853404828189643214087638328376675071962141118973835178054884474523241911240926274907256651801384433652425740230755811160476356172444327762497910600719286629420662696949923799255603628210458906831175806791599965316549386396788014703044837917283461862338269599464440202019922379625071512100821922879623930069349084917919100015782270736808388388006084027673781004085620817521378823838335749279055639005125
n1 =  343504538870081878757729748260620800783581983635281373321527119223374418103340873199654926888439040391545101913132680017655039577253974802351999985470115474655124168592386965001556620077117966153475518658881140827499124290142523464795351995478153288872749817655925271395693435582010998996210909883510311066017237567799370371513462802547313382594409676803895262837061350017911885033133654781876923251129406855067993830824618637981136966134029212516871210627954762147349788788999116702635535406398258621926040887099782494271000823401788337120154104692934583729065189687995570122890809807661370008740283447636580308161498808092269041815719148127168137018600113465985504975054319601741498799761500526467431533990903047624407330243357514588557352746347337683868781554819821575385685459666842162355673947984514687068626166144076257334426612302554448774082488600083569900006274897032242821388126274957846236552373226099112200392102883351088570736254707966329366625911183721875374731791052229266503696334310835323523568132399330263642353927504971311717117370721838701629885670598853025212521537158141447625623337563164790788106598854822686494249848796441153496412236527242235888308435573209980270776407776277489669763803746640746378181948641
c2 =  4948422459907576438725352912593232312182623872749480015295307088166392790756090961680588458629287353136729331282506869598853654959933189916541367579979613191505226006688017103736659670745715837820780269669982614187726024837483992949073998289744910800139692315475427811724840888983757813069849711652177078415791290894737059610056340691753379065563574279210755232749774749757141836708161854072798697882671844015773796030086898649043727563289757423417931359190238689436180953442515869613672008678717039516723747808793079592658069533269662834322438864456440701995249381880745586708718334052938634931936240736457181295
n2 =  8582505375542551134698364096640878629785534004976071646505285128223700755811329156276289439920192196962008222418309136528180402357612976316670896973298407081310073283979903409463559102445223030866575563539261326076167685019121804961393115251287057504682389257841337573435085535013992761172452417731887700665115563173984357419855481847035192853387338980937451843809282267888616833734087813693242841580644645315837196205981207827105545437201799441352173638172133698491126291396194764373021523547130703629001683366722885529834956411976212381935354905525700646776572036418453784898084635925476199878640087165680193737
p,q = 19024691283015651666032297670418553586155390575928421823630922553034857624430114628839720683172187406577114034710093054198921843669645736474448836706112221787749688565566635453151716934583685087745112614898780150391513798368931496744574075511968933800467288441832780919514199410584786925010518564670786685241724643282580795568609339268652910564215887176803735675069372979560024792322029911970574914829712553975379661212645059271137916107885326625543090473004683836665262304916304580076748336858662108554591235698235221618061328251985929904075811056422186525179189846420226944944513865790999242309352900287977666792901,18055722101348711626577381571859114850735298658417345663254295930584841136416234624852520581982069555948490061840244710773146585295336094872892685938420880462305333393436098181186277450475949236132458958671804132443554885896037342335902958516394876382378829317303693655605215373555988755516058130500801822723195474873517960624159417903134580987202400855946137101429970119186394052011747475879598126195607938106163892658285305921071673588966184054026228745012993740035399652049777986535759039077634555909031397541116025395236871778797949216479130412500655359057128438928721459688727543057760739527720641179290282309741
primes = [10864078180916418691, 10049235158029375571, 12448177342966243757, 17093292308638969889, 16123604149048919099, 15175734709842430433, 18106525049998616747, 11092420583960163379, 15751974537676958401, 18345408081492711641, 14745811312384518031, 9949603102225364603, 12034779627328165471, 13062839684118954553, 14813953870710226847, 15332916111580607077, 17265001711647542137, 16870346804576162551, 15211380502610462057, 14678737767649343977, 13645878578452317313, 18390046459144888243, 14397830993057803133, 17543713628803023199, 16408421615173973083, 17673334943789572513, 12404642343676224637, 10547615587767500213, 11853704782834170959, 17289161209347211817, 10596280721192026229, 14619040595108594017]
from math import prod
m1 = pow(c1,pow(e,-1,(p-1)*(q-1)),n1)
m2 = pow(c2,pow(e,-1,prod(x-1 for x in primes)),n2)
int.to_bytes(m1,byteorder='big',length=m1.bit_length()//8+1)+int.to_bytes(m2,byteorder='big',length=m2.bit_length()//8+1)
```

## rsa_signin

å¸¸è§å¥—è·¯é¢˜ï¼Œç”¨ä¸åŒçš„nå’Œç›¸åŒçš„eåŠ å¯†åŒä¸€ä¸ªmã€‚é™„ä»¶ç»™äº†ä¸€å †nå’Œcï¼ŒæŒ‰ç…§å¥—è·¯åº”è¯¥æ˜¯ï¼Œå…¶ä¸­æœ‰è‡³å°‘ä¸€å¯¹nä¸äº’è´¨ï¼Œå› æ­¤å¯ä»¥ç”¨gcdå¿«é€Ÿåˆ†è§£nã€‚~~ç„¶åå°±æœ‰å­¦å¼Ÿé—®èƒ½ä¸èƒ½ç”¨CRTæ¥åš~~

```python
from math import gcd
c1 = 6269656777204332618433779865483197625538144405832409880710764183039800286008967127279281167109250083159801218370191973055663058165456565194979210256278526713608759141588082614531352489547674696723140599892318118960648862531538435596775798128845789504910467783731144808685373807716609662688064728614003904579841055786083326311313295311152563668422289435606771091246147867715987583149743032723028324394173498623642539175178996531881058274717907066845565199058931743481410454382746158558886667761300257488769795092777021292335562818583719708133179974425584610403335487082478848975656282384575767178925517257692365828720
n1 = 21457499145521259498911107987303777576783467581104197687610588208126845121702391694574491025398113729462454256070437978257494064504146718372095872819969887408622112906108590961892923178192792218161103488204912792358327748493857104191029765218471874759376809136402361582721860433355338373725980783308091544879562698835405262108188595630215081260699112737457564998798692048522706388318528370551365364702529068656665853097899157141017378975007689790000067275142731212069030175682911154288533716549782283859340452266837760560153014200605378914071410125895494331253564598702942990036163269043699029806343766286247742865671
n2 = 14215826065753265334521416948225868542990756976323308408298887797364519400310818641526401662106853573185085731682502059761982246604277475488691297554851873224516934619888327644352138127883043558424300092247604877819821625587944308487310522092440517150600171819145803937177931473336108429889165189521078678397694303305705260759351843006130968234071638035667854938070597400634242396852782331461576526836227336952718230741560369621645218729592233657856104560425642219241082727756696967324334634822771842625681505869025740662258929200756109704988223034840699133778958569054445520305361142302393767439478256174414187983763
p = gcd(n1, n2)
q = n1 // p
e = 65537
phi = (p - 1) * (q - 1)
d = pow(e, -1, phi)
m = pow(c1, d, n1)
print(m.to_bytes((m.bit_length() + 7) // 8, "big"))
```

## |p-q|

p,q å¤§å°ç›¸è¿‘ï¼Œé‚£å°±ç›´æ¥ä»¤`p < q`ï¼Œç›´æ¥å¯¹nå¼€æ–¹ï¼Œå»æœç´¢på’Œq

å¯ä»¥å‚è€ƒ[ctf-wiki](https://ctf-wiki.org/crypto/asymmetric/rsa/rsa_module_attack/#p-q_1)

```python
n = 329960318345010350458589325571454799968957932130539403944044204698872359769449414256378111233592533561892402020955736786563103586897940757198920737583107357264433730515123570697570757034221232010688796344257587359198400915567115397034901247038275403825404094129637119512164953012131445747740645183682571690806238508035172474685818036517880994658466362305677430221344381425792427288500814551334928982040579744048907401043058567486871621293983772331951723963911377839286050368715384227640638031857101612517441295926821712605955984000617738833973829140899288164786111118033301974794123637285172303688427806450817155786233788027512244397952849209700013205803489334055814513866650854230478124920442832221946442593769555237909177172933634236392800414176981780444770542047378630756636857018730168151824307814244094763132088236333995807013617801783919113541391133267230410179444855465611792191833319172887852945902960736744468250550722314565805440432977225703650102517531531476188269635151281661081058374242768608270563131619806585194608795817118466680430500830137335634289617464844004904410907221482919453859885955054140320857757297655475489972268282336250384384926216818756762307686391740965586168590784252524275489515352125321398406426217
c = 307746143297103281117512771170735061509547958991947416701685589829711285274762039205145422734327595082350457374530975854337055433998982493020603245187129916580627539476324521854057990929173492940833073106540441902619425074887573232779899379436737429823569006431370954961865581168635086246592539153824456681688944066925973182272443586463636373955966146029489121226571408532284480270826510961605206483011204059402338926815599691009406841471142048842308786000059979977645988396524814553253493672729395573658564825709547262230219183672493306100392069182994445509803952976016630731417479238769736432223194249245020320183199001774879893442186017555682902409661647546547835345461056900610391514595370600575845979413984555709077635397717741521573798309855584473259503981955303774208127361309229536010653615696850725905168242705387575720694946072789441481191449772933265705810128547553027708513478130258801233619669699177901566688737559102165508239876805822898509541232565766265491283807922473440397456701500524925191214292669986798631732639221198138026031561329502985577205314190565609214349344303324429408234237832110076900414483795318189628198913032900272406887003325858236057373096880675754802725017537119549989304878960436575670784578550
from Crypto.Util.number import long_to_bytes
from gmpy2 import iroot
p = iroot(n, 2)[0]
while n % p != 0:
    p -= 1
q = n // p
phi = (p - 1) * (q - 1)
e = 65537
d = pow(e, -1, phi)
m = pow(c, d, n)
print(long_to_bytes(m))
```

## n&n

å¸¸è§çš„å…±æ‘¸æ”»å‡»

å¯ä»¥å‚è€ƒ[ctf-wiki](https://ctf-wiki.org/crypto/asymmetric/rsa/rsa_module_attack/#_7)

```python
import gmpy2
from Crypto.Util.number import *
e1 = 0x114514
e2 = 19198101
c1 = 5776799746376051463605370130675046329799612910435315968508603116759552095183027263116443417343895252766060748671845650457077393391989018107887540639775168897954484319381180406512474784571389477212123123540984850033695748142755414954158933345476509573211496722528388574841686164433315356667366007165419697987147258498693175698918104120849579763098045116744389310549687579302444264316133642674648294049526615350011916160649448726069001139749604430982881450187865197137222762758538645387391379108182515717949428258503254717940765994927802512049427407583200118969062778415073135339774546277230281966880715506688898978925
c2 = 4664955020023583143415931782261983177552050757537222070347847639906354901601382630034645762990079537901659753823666851165175187728532569040809797389706253282757017586285211791297567893874606446000074515260509831946210526182765808878824360460569061258723122198792244018463880052389205906620425625708718545628429086424549277715280217165880900037900983008637302744555649467104208348070638137050458275362152816916837534704113775562356277110844168173111385779258263874552283927767924979691542028126412133709129601685315027689094437957165812994784648540588277901241854031439324974562449032290219652206466731675967045633360
n = 13612969130810965900902742090064423006385890357159609755971027204203418808937093492927060428980020085273603754747223030702684866992231913349067578014240319426522039068836171388168087260774376277346092066880984406890296520951318296354893551565670293486797637522297989653182109744864444697818991039473180752980752117041574628063002176339235126861152739066489620021077091941250365101779354009854706729448088217051728432010328667839532327286559570597994183126402340332924370812383312664419874352306052467284992411543921858024469098268800500500651896608097346389396273293747664441553194179933758992070398387066135330851531
g,x,y = gmpy2.gcdext(e1,e2)
print(long_to_bytes((pow(c1,x,n) * pow(c2,y,n))%n))
```

## ez_chain

ä¸€ä¸ªç®€å•çš„cbcåŠ å¯†ï¼Œç¬¬ä¸€ä¸ªblockçš„æ˜æ–‡æ˜¯å·²çŸ¥çš„ï¼Œä¸”å·²çŸ¥ivï¼Œåˆ™å¯ä»¥ç›´æ¥æ±‚å‡ºkeyï¼Œç„¶åè§£å¯†å³å¯

```python
from Crypto.Util.number import *
base = bytes_to_long(b"koito")

def blockize(long):
    out = []
    while long>0:
        out.append(long % base)
        long //= base
    return list(reversed(out))

def deblockize(blocks):
    out = 0
    for block in blocks:
        out *= base
        out += block
    return out

blocks = [8490961288, 122685644196, 349851982069, 319462619019, 74697733110, 43107579733, 465430019828, 178715374673, 425695308534, 164022852989, 435966065649, 222907886694, 420391941825, 173833246025, 329708930734]

def encrypt_block_cbc(blocks, iv, key):
    encrypted = [iv]
    for i in range(len(blocks)):
        encrypted.append(blocks[i] ^ encrypted[i] ^ key)
    return encrypted[1:]

def decrypt_block_cbc(blocks, iv, key):
    encrypted = [iv,*blocks]
    decrypted = []
    for i in range(len(blocks)):
        decrypted.append(encrypted[i] ^ encrypted[i+1] ^ key)
    return decrypted

iv = 3735927943
key = blockize(bytes_to_long(b"moectf{" + b"A"*64 + b"}"))[0] ^ iv ^ blocks[0]

long_to_bytes(deblockize(decrypt_block_cbc(blocks, iv, key)))
```

## bad_e

ç»è¿‡è®¡ç®—å¾ˆå®¹æ˜“å‘ç° $e$ ä¸ $\phi(p*q)$ ä¸äº’ç´ ï¼Œæ›´è¿›ä¸€æ­¥åœ° $gcd(q-1, e) = 1$ ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å…ˆè®¡ç®— $m\bmod q$ çš„ç»“æœï¼Œè®¡ç®— $e*d = 1 (mod \phi(q))$ ã€‚ç”±äºæ­¤å¤„ $m < q$ ,æˆ‘ä»¬å°†æ¨¡æ¢æˆ $q$ åè§£å¯†ä¾¿å¾—åˆ°äº†æ˜æ–‡

```python
from Crypto.Util.number import *
p = 6853495238262155391975011057929314523706159020478084061020122347902601182448091015650787022962180599741651597328364289413042032923330906135304995252477571
q = 11727544912613560398705401423145382428897876620077115390278679983274961030035884083100580422155496261311510530671232666801444557695190734596546855494472819
e = 65537
c = 63388263723813143290256836284084914544524440253054612802424934400854921660916379284754467427040180660945667733359330988361620691457570947823206385692232584893511398038141442606303536260023122774682805630913037113541880875125504376791939861734613177272270414287306054553288162010873808058776206524782351475805
d = pow(e,-1,q-1)
print(long_to_bytes(pow(c%q,d,q)%q))
```

## giant_e

~~è¿™é¢˜æœ¬æ¥æ˜¯æˆ‘éšä¾¿ç³Šçš„ä¸€ä¸ªWiener's Attackï¼Œæ²¡æƒ³åˆ°è¿˜æœ‰åŸºäºæ ¼å¯†ç çš„åšæ³•ï¼Œçœ‹æ¥æˆ‘çš„æ°´å¹³è¿˜æ˜¯ä½äº†ğŸ¥ºğŸ¥º~~

ç›®æµ‹eéå¸¸å¤§ï¼Œåˆ™dè¶³å¤Ÿå°ï¼Œå¯ä»¥ä½¿ç”¨[Wiener's Attack](https://ctf-wiki.org/crypto/asymmetric/rsa/d_attacks/rsa_d_attack/#wieners-attack)æ¥è·å¾—ç§é’¥

```python
from gmpy2 import iroot

def rational_to_contfrac(x,y):
    '''
    Converts a rational x/y fraction into
    a list of partial quotients [a0, ..., an]
    '''
    a = x//y
    pquotients = [a]
    while a * y != x:
        x,y = y,x-a*y
        a = x//y
        pquotients.append(a)
    return pquotients

def convergents_from_contfrac(frac):
    '''
    computes the list of convergents
    using the list of partial quotients
    '''
    convs = []
    for i in range(len(frac)):
        convs.append(contfrac_to_rational(frac[0:i]))
    return convs

def contfrac_to_rational (frac):
    '''Converts a finite continued fraction [a0, ..., an]
     to an x/y rational.
     '''
    if len(frac) == 0:
        return (0,1)
    num = frac[-1]
    denom = 1
    for _ in range(-2,-len(frac)-1,-1):
        num, denom = frac[_]*num+denom, num
    return (num,denom)

def hack_RSA(e,n):
    '''
    Finds d knowing (e,n)
    applying the Wiener continued fraction attack
    '''
    frac = rational_to_contfrac(e, n)
    convergents = convergents_from_contfrac(frac)
    
    for (k,d) in convergents:
        #check if d is actually the key
        if k!=0 and (e*d-1)%k == 0:
            phi = (e*d-1)//k
            s = n - phi + 1
            # check if the equation x^2 - s*x + n = 0
            # has integer roots
            discr = s*s - 4*n
            if(discr>=0):
                r,t = iroot(discr,2)
                if t and (s+r)%2==0:
                    print("Hacked!")
                    return d

n = 0xbaa70ba4c29eb1e6bb3458827540fce84d40e1c966db73c0a39e4f9f40e975c42e02971dab385be27bd2b0687e2476894845cc46e55d9747a5be5ca9d925931ca82b0489e39724ea814800eb3c0ea40d89ebe7fe377f8d3f431a68d209e7a149851c06a4e67db7c99fcfd9ec19496f29d59bb186feb44a36fe344f11d047b9435a1c47fa2f8ed72f59403ebb0e439738fd550a7684247ab7da64311690f461e6dce03bf2fcd55345948a3b537087f07cd680d7461d326690bf21e39dff30268cb33f86eeceff412cd63a38f7110805d337dcad25e6f7e3728b53ca722b695b0d9db37361b5b63213af50dd69ee8b3cf2085f845d7932c08b27bf638e98497239
c = 0x45a9ce4297c8afee693d3cce2525d3399c5251061ddd2462513a57f0fd69bdc74b71b519d3a2c23209d74fcfbcb6b196b5943838c2441cb34496c96e0f9fc9f0f80a2f6d5b49f220cb3e78e36a4a66595aa2dbe3ff6e814d84f07cb5442e2d5d08d08aa9ccde0294b39bfde79a6c6dcd2329e9820744c4deb34a039da7933ddf00b0a0469afb89cba87490a39783a9b2f8f0274f646ca242e78a326dda886c213bc8d03ac1a9150de4ba08c5936c3fe924c8646652ef85aa7ac0103485f472413427a0e9d9a4d416b99e24861ca8499500c693d7a07360158ffffa543480758cafff2a09a9f6628f92767764fa026d48a9dd899838505ae16e38910697f9de14
e = 0x609778981bfbb26bb93398cb6d96984616a6ab08ade090c1c0d4fedb00f44f0552a1555efec5cc66e7960b61e94e80e7483b9f906a6c8155a91cdc3e4917fa5347c58a2bc85bb160fcf7fe98e3645cfea8458ea209e565e4eb72ee7cbb232331a862d8a84d91a0ff6d74aa3c779b2b129c3d8148b090c4193234764f2e5d9b2170a9b4859501d07c0601cdd18616a0ab2cf713a7c785fd06f27d68dff24446d884644e08f31bd37ecf48750e4324f959a8d37c5bef25e1580851646d57b3d4f525bc04c7ddafdf146539a84703df2161a0da7a368675f473065d2cb661907d990ba4a8451b15e054bfc4dd73e134f3bf7d8fa4716125d8e21f946d16b7b0fc43

d = hack_RSA(e,n)
m = pow(c,d,n)
print(int.to_bytes(m, 72, 'big'))
```

## minipack

è§‚å¯Ÿä¸€ä¸‹å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªåºåˆ—æ˜¯ä¸ªè¶…é€’å¢åºåˆ—ï¼Œå³åºåˆ—çš„æ¯ä¸€é¡¹éƒ½å¤§äºå…ˆå‰æ‰€æœ‰é¡¹ä¹‹å’Œï¼Œç›´æ¥å†™è„šæœ¬è§£å¯†

```python
with open("key.txt") as fs:
    key = eval(fs.read())
with open("ciphertext.txt") as fs:
    c = eval(fs.read())

def bits2long(bits):
    long = 0
    for bit in bits:
        long <<= 1
        long |= bit
    return long

def decrypt(c,keys):
    bits = []
    for k in reversed(keys):
        if c >= k:
            bits.append(1)
            c -= k
        else:
            bits.append(0)
            c-= 1
    assert c == 0,c
    return list(reversed(bits))

print(bits2long(decrypt(c,key)).to_bytes(74))
```

## xorrrrrrrrr

é¦–å…ˆå¾—æƒ³ä¸ªåŠæ³•ï¼ŒåŠ è½½é‚£ä¸€å †æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œåˆç†è¿ç”¨ä¸€ä¸‹evalï¼ˆ

```python
data = eval("["+",".join(open("result.log").readlines())+"]")
for x in data:
    assert len(x) == 72
```

å› ä¸ºå·²çŸ¥éƒ¨åˆ†æ˜æ–‡ï¼ˆå¼€å¤´çš„moectfï¼‰ï¼Œæ‰€ä»¥å…ˆå¯¹å‰é¢çš„éƒ¨åˆ†xor

```python
strxor = lambda s1,s2: bytes([x^y for x,y in zip(s1,s2)])
partials = []
for x in data:
    print((partial := strxor(b"moectf{",x)))
    partials.append(partial)
```

å¯ä»¥å¾—åˆ°å¾ˆå¤šæ–‡ç« çš„ç‰‡æ®µï¼Œè¿›è¡Œæ¯”è¾ƒ

```python
for x in range(100):
    central = partials[x][1:6]
    for y in range(x+1,100):
        if central in partials[y]:
            print(x,y,partials[x],partials[y])
            break
```

å¯ä»¥å‘ç°æœ‰éƒ¨åˆ†ç‰‡æ®µçš„å†…å®¹æ˜¯ç›¸è¿‘çš„ï¼Œåˆç†çŒœæµ‹ï¼Œè¿™äº›ç‰‡æ®µå¯èƒ½åœ¨æ–‡ç« ä¸­æ˜¯ç›¸äº’é‡å çš„ï¼Œæ­¤å¤„é€‰å–28å’Œ33è¿›è¡Œå°è¯•è§£å¯†

```python
c1 = data[33]
c2 = data[28]
flag = [ord("m")] + [0]*71
for x in range(1,72):
    flag[x] = flag[x-1] ^ c1[x] ^ c2[x-1]
print(bytes(flag))
```

## flag_exchange

ä¸€ä¸ªç®€å•çš„Diffie-Hellman Key Exchangeï¼Œè®¡ç®—å‡ºsuperkeyå³å¯å¾—åˆ°flagï¼Œå› æ­¤æœ¬é¢˜å¯ä»¥å½’ç»“ä¸ºæ±‚ç¦»æ•£å¯¹æ•°é—®é¢˜ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªå…‰æ»‘æ•°ä½œä¸ºpï¼Œç„¶åä½¿ç”¨sagemathè¿›è¡Œè®¡ç®—ç¦»æ•£å¯¹æ•°

```python
p = 13235062921662694429211184891220141973285969028958016790661658609292023032453887458389574420664371217218833375173082540739555090686687826551693380798574629365254210787419070348340076227508521415632755789594367616391764583712987637766374230688082101873347891400341145784790200266806419168972691757367828474132879
g = 7
alice_c = 1221640590766898549362642749956190247046901295126823096389539054496577676904148725306871415304625357679274758123967130575806395283705650387211451955491880564048849695390063646473446448370517037665298208206300160345895158808656308613957029787101620962105888547352504224570244674070079145383955711162728478536046
bob_c = 10914058150041579228335044825069147660151048009833232499423274241091205307378822591756611171003771345094040632765282436546079380374006417156952521571712847727147667197633718630381965034157472542711445980389164469962687527461825566020040260085757602044987125601005370199841480567305046882686309909194474406616077
c = 4347075310808811365764149394116801872058145217058026761208397630328499276273760675800722813675312623993292132495593299151727221662550697088904575544150269857708718246311308661191716111648871307338719826798387293086431800182087626952538664402203626468441387174230294906432594571442142256792989022176545512970776

F = IntegerModRing(p)
alice = discrete_log(F(alice_c), F(g))
print(alice)

from Crypto.Util.number import long_to_bytes
alice = 37993409039175784589457143359239267408494079933728174984655637174962014403696993530490680524035509941567185477731183292567076906604149806752690437997335275029395313176701922026827247662737470462544532276746044792875332400764315172024417758485968248093577080036097463298532034571247538297840514743856478951558

superkey = pow(bob_c, alice, p)
m = c * pow(superkey, -1, p) % p
print(long_to_bytes(m))
```

## broken_hash

```python
def F(x: int, y: int, z: int) -> int:
    return ((x & ~y) ^ (y & ~z) ^ (z & ~x)) ^ (
        ((x + y) * (y + z) + (x + z)) & 0xFFFF_FFFF_FFFF_FFFF_FFFF_FFFF_FFFF_FFFF
    )


def _block_hash(a: int, b: int, c: int, d: int) -> int:
    x, y, z, w = F(a, b, c), F(b, c, d), F(c, d, a), F(d, a, b)
    return (a ^ b ^ c ^ d ^ x ^ y ^ z ^ w) ^ 0xFFFF_FFFF_FFFF_FFFF_FFFF_FFFF_FFFF_FFFF


def _hash(blocks: list[int]) -> int:
    length = len(blocks)
    if length % 4 != 0:
        padding = 4 - length % 4
        blocks += [0] * padding
        length += padding
    if length == 4:
        return _block_hash(*blocks)
    else:
        block_size = length // 4
        h1 = _hash(blocks[:block_size])
        h2 = _hash(blocks[block_size : block_size * 2])
        h3 = _hash(blocks[block_size * 2 : block_size * 3])
        h4 = _hash(blocks[block_size * 3 :])
        return _block_hash(h1, h2, h3, h4)


def bytes2blocks(data: bytes, block_size=16) -> list[int]:
    if len(data) % block_size != 0:
        data += b"\x00" * (block_size - len(data) % block_size)
    return [
        int.from_bytes(data[i : i + block_size], "little")
        for i in range(0, len(data), block_size)
    ]


def hash(*data: list[bytes]) -> int:
    return _hash(bytes2blocks(b"".join(data)))
```

`_block_hash`æ¥å—å››ä¸ªblockä½œä¸ºå‚æ•°ï¼Œä¸”çœ‹èµ·æ¥æœ‰è½®æ¢å¯¹ç§°æ€§ï¼Œå†™è„šæœ¬éªŒè¯

```python
from itertools import permutations
for i in permutations([b"1",b"2",b"3",b"4"]):
    print(b"".join(i),hash(*(x*16 for x in i)))
```

è„šæœ¬è¾“å‡ºå¯ä»¥éªŒè¯çŒœæƒ³ï¼Œå­˜åœ¨éƒ¨åˆ†äº¤æ¢ä½¿hashä¸å˜

```python
from base64 import b64decode,b64encode
data = b64decode("RoZqav2gsy4OrPb9w0dd80XAsmQrbq0UGSvg2H9TYeG9PoepDdhJSCDCXdCc5wotHi6Ua3dN/4rQQ6L6RZpVBDKimKEMnccmz2R6h/6YYjGb7yURhO2bvGr9+JeUjZ/x/9o3IC+gvlJ4TnOGXPi6MKdhr4yZ7OC8UT6Ht9IKZhEzOmw6u9FXr95pnINhdVaqYspJzI21NM7JctkOWrdflIqJG1HC3qxpQ9Xnqn3nfiQmKx4AKrF10F5VhMDPy/ClubMSZVO2ylQ8w+pX2KN0ze2rOrlo3Ogt9+DgAxJokLaSSkwfjylRzVvjSN/4Tvj2GFCkPpFb33QJhF42OrnUpw==")
payload = b""
for x in range(4):
    a = data[64*x:64*x+64]
    for y in range(3,-1,-1):
        b = a[16*y:16*y+16]
        payload += b
b64encode(payload)
```

## factorize_me

~~å·ä¸€éƒ¨åˆ†æ ¡å†…é€‰æ‰‹Orac1eçš„åˆ†æï¼ˆè¿™æ°´å¹³ç›´æ¥è–„çº±æˆ‘äº†qwqï¼‰~~

è€ƒå¯Ÿ$RSA$ä¸­çš„è§£å¯†æŒ‡æ•°$d$æ³„éœ²é—®é¢˜ã€‚

è¿™ç§é—®é¢˜éå¸¸ä¸¥é‡ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ä»…å¯ä»¥ç›´æ¥è§£å¯†å¯†æ–‡ï¼Œç”šè‡³å¯ä»¥æ ¹æ®$d,e,N$çš„å€¼æ¥åšåˆ°æœ‰æ•ˆåˆ†è§£$N$ã€‚

åœ¨æœ¬é¢˜ä¸­æˆ‘ä»¬çŸ¥é“$\phi(N)$çš„å€¼ï¼Œä¸ä¹‹ç­‰æ•ˆã€‚

å½“$N = pq$æ—¶ï¼Œå·²çŸ¥$d*e = 1 + k*\phi(N)$ï¼Œè€Œç”±æ¬§æ‹‰å®šç†çŸ¥
$$a^{d*e - 1} = 1 \bmod N \quad gcd(a, p*q) = 1$$
æ³¨æ„åˆ°$d*e-1$ä¸ºå¶æ•°ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥å°†å…¶è¡¨ç¤ºä¸º$2^{t}*g$çš„å½¢å¼ï¼Œå…¶ä¸­$g$ä¸ºå¥‡æ•°ã€‚
æˆ‘ä»¬è®¡ç®—ä¸€ä¸‹$a^{d*e-1}-1$,å¾—åˆ°å¦‚ä¸‹åˆ†è§£ï¼š
$$a^{d*e-1} - 1 = a^{2^{t}*g} - 1 = (a^{g} - 1)(a^{g} + 1)(a^{2*g}+1)\cdots (a^{2^{t-1}*g}+1)=0 \bmod N$$
å› ä¸º$N=P*Q$,$P,Q$å‡ä¸ºç´ æ•°ã€‚æ•…æˆ‘ä»¬å¯ä»¥è®¡ç®—ä¸Šè¿°åˆ†è§£å¼ä¸­å„é¡¹ä¸$N$çš„æœ€å¤§å…¬çº¦æ•°,å¦‚æœå‘ç°$GCD(a^{2^{i}*g} - 1, N) \neq 1,N$,æˆ‘ä»¬ä¾¿æœ‰æ•ˆåˆ†è§£æ‰äº†$N$ã€‚

ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯ä¸€ä¸ªæ¦‚ç‡ç®—æ³•ï¼Œåˆ†è§£çš„æˆåŠŸä¸å¦å–å†³äº$a$çš„é€‰å–ï¼Œæ ¹æ®å®é™…æ±‚è§£çš„ç»éªŒï¼Œç¬”è€…ä¸€èˆ¬æ˜¯é€‰æ‹©ç”¨åˆ†è§£å‡ºæ¥çš„å› å­é€ä¸ªä½œä¸º$a$,ä¾æ¬¡åˆ†è§£ï¼Œè¿™æ ·çš„æˆåŠŸç‡æ¯”è¾ƒé«˜ã€‚

```python
n_ = 363364907814244019888662301376841344262476227242899756862391470731421569394957444030214887114615748277199649349781524749919652160244484352285668794188836866602305788131186220057989320357344904731322223310531945208433910803617954798258382169132907508787682006064930747033681966462568715421005454243255297306718356766130469885581576362173340673516476386201173298433892314145854649884922769732583885904512624543994675379894718657682146178638074984373206937523380103438050549181568015985546172618830480078894445808092527561363650503540062128543705172678754195578429520889784813733491180748361345720247750720179608752244490362713103319685024237941527268458213442611663415417005556439749055222361212059968254748751273361732365487788593341859760309778894350385339764442343374673786357175846291309425081492959910254127778240522152676060766139057453197528944251599979227271074508795482632471242983094008619339488744362509349734218480932255216087706001484182136783834973304870508270118505737767002256270427907341952256516206663258530300791364944105025764611810001781971638030661367630116818647252727909489405550104641122269772492252464714694507693447974171377200402508765841829763548525530878309985480248379655169722567051495205792089930014228403456098065971372039443284193603395249634283366194562380309469628114581468645669390610963076340643757972439104287127375438663839421605531570285615180251
phi_ = 363364907814244019888662301376841344262476227242899756862391470731421569394957444030214887114615748277199649349781524749919652160244484352285668794188836492373364350673588273863828369502073826782362255108313852264064760467561392054178047091483873483255491431451728274259516789065331176728192953741805933100379191778599394515981288225535175013258094287912195847642598436035132783919453991516358280321085873745330313812205910011387125778714795906023110368957596998222544234082487264006696812862179916726781327290284827659294751262185328816323311831349296593013038823107653943652771448719760448938995150646738377177532550757319539185878535087009904848382493668686831331474113789651777885239747000076063679062106375348803749466079052774597412239427050432901553466002731972993029311850718200685157193170716432600165476733200831046297530470544781309612128231925681374239849452623513538498417735984094919756374577623486416462101457492789215144166273775249387638107644634704270216130852885082174564648445147377239033930079759024399532146184753110240154062693457622208373371290126810856885343328090305620627668495081760346853701632815149478447405718664667978825807101325764916405446176183238866136433205933785973568759281210319422288153910340542098573782006262190181726245838857185687242960093445000287347616796984610291664809895901301187179157382169999966124177588884152267266994164841066291200
n = 899081756851564072995842371038848265712822308942406479625157544735473115850983700580364485532298999127834142923262920189902691972009898741820291331257478170998867183390650298055916005944577877856728843264502218692432679062445730259562784479410120575777748292393321588239071577384218317338474855507210816917917699500763270490789679076190405915250953860114858086078092945282693720016414837231157788381144668395364877545151382171251673050910143023561541226464220441
e = 65537
c = 841335863342518623856757469220437045493934999201203757845757404101093751603513457430254875658199946020695655428637035628085973393246970440054477600379027466651143466332405520374224855994531411584946074861018245519106776529260649700756908093025092104292223745612991818151040610497258923925952531383407297026038305824754456660932812929344928080812670596607694776017112795053283695891798940700646874515366341575417161087304105309794441077774052357656529143940010140

from Crypto.Util.number import isPrime
from math import gcd
from random import randrange

def factorize_multi_prime(N, phi):
    """
    Recovers the prime factors from a modulus if Euler's totient is known.
    This method works for a modulus consisting of any number of primes, but is considerably be slower than factorize.
    More information: Hinek M. J., Low M. K., Teske E., "On Some Attacks on Multi-prime RSA" (Section 3)
    :param N: the modulus
    :param phi: Euler's totient, the order of the multiplicative group modulo N
    :return: a tuple containing the prime factors
    """
    prime_factors = set()
    factors = [N]
    while len(factors) > 0:
        # Element to factorize.
        N = factors[0]
        w = randrange(2, N - 1)
        i = 1
        while phi % (2**i) == 0:
            sqrt_1 = pow(w, phi // (2**i), N)
            if sqrt_1 > 1 and sqrt_1 != N - 1:
                # We can remove the element to factorize now, because we have a factorization.
                factors = factors[1:]
                p = gcd(N, sqrt_1 + 1)
                q = N // p
                if isPrime(p):
                    prime_factors.add(p)
                elif p > 1:
                    factors.append(p)
                if isPrime(q):
                    prime_factors.add(q)
                elif q > 1:
                    factors.append(q)
                # Continue in the outer loop
                break
            i += 1
    return tuple(prime_factors)

primes = factorize_multi_prime(n_, phi_)
from sympy import nextprime
primes2 = [nextprime(p) for p in primes]
primes3 = [p for p in primes2 if n % p == 0]

from math import prod
from Crypto.Util.number import long_to_bytes
phi = prod(p - 1 for p in primes3)
d = pow(e,-1, phi)
m = pow(c, d, n)
print(long_to_bytes(m))
```

## bad_random

LCGè¡¨è¾¾å¼ä¸º
$$x_{i+1} = a * x_{i} + c\bmod m$$

ç›¸é‚»é¡¹åšå·®å¾—åˆ° $t_{i}$ åºåˆ—
$$t_{i+1} = x_{i+2} - x_{i+1} = a * (x_{i+1} - x_{i}) \bmod m$$

æ˜“å¾—
$$t_{i+2} * t_{i} - t_{i+1} ^ 2 = (a^2 * t_{i}) * t_{i} - (a * t_{i}) ^ 2 = 0 \bmod m$$

å³
$$ t_{i+2} * t_{i} - t_{i+1} ^ 2 = k * m ,\quad k \in \mathbb{Z} $$

ä»¤
$$ m_{i} = t_{i+2} * t_{i} - t_{i+1} ^ 2 $$

åˆ™å¯¹ $m_{i}$ åºåˆ—æ±‚gcdï¼Œå¤§æ¦‚ç‡ä¸ºm

```python
from math import gcd
def gcd_all(*args):
    d = args[0]
    for i in args[1:]:
        d = gcd(d,i)
    return d
def solve_m(x_):
    t_ = [x_[i+1] - x_[i] for i in range(len(x_)-1)] 
    m_ = [t_[i+1] * t_[i-1] - t_[i] ** 2 for i in range(1,len(t_)-1)]
    return gcd_all(*m_)
def solve_a(x1,x2,x3,m):
    return ((x3-x2) * pow(x2-x1,-1,m))%m
def solve_c(x1,x2,a,m):
    return (x2-a*x1)%m
```

ï¼ˆäº¤äº’éƒ¨åˆ†æ²¡å†™ï¼Œå¯ä»¥æ‰‹åŠ¨äº¤äº’å‡ æ¬¡æ±‚m a cä¸‰ä¸ªå‚æ•°ï¼Œç„¶åå›ä»£æ±‚ä¸‹ä¸ªè¾“å‡ºï¼Œå¤šè·‘å‡ æ¬¡ä¸€èˆ¬å³å¯å‡ºç»“æœï¼‰

## feistel

## feistel_promax


